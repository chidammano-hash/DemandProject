# Feature 3: Dimension Tables

## Objective
Define all five dimension tables for the demand forecasting platform: Item, Location, Customer, Time, and DFU.

---

## 3A. Item Dimension (`dim_item`)

### Purpose
Standard item master data for planning.

### Table
`dim_item`

### Required Fields
- `item_no` (item number)
- `item_desc` (item description)
- `item_status`
- `brand_name`
- `category`
- `class`
- `sub_class`
- `country`
- `scm_rtd_flag` (ready-to-drink flag)
- `size` (item size descriptor)
- `case_weight` (weight per case)
- `cpl` (cases per layer)
- `cpp` (cases per pallet)
- `lpp` (layers per pallet)
- `case_weight_uom`
- `bpc`
- `bottle_pack`
- `pack_case`
- `item_proof`
- `upc`
- `national_service_model`
- `supplier_no`
- `supplier_name`
- `item_is_deleted`
- `producer_name`

### Internal Fields
- `item_sk`
- `item_ck` (same as `item_no`)
- `load_ts`
- `modified_ts`

### Rules
- one row per `item_ck` (`item_no`)
- required fields must be populated
- numeric fields must be valid: `case_weight`, `cpl`, `cpp`, `lpp`, `bpc`, `bottle_pack`, `pack_case`, `item_proof`

---

## 3B. Location Dimension (`dim_location`)

### Purpose
Standard location dimension for planning.

### Table
`dim_location`

### Required Fields
- `location_id` (location identifier)
- `site_id` (site grouping identifier)
- `site_desc` (site description)
- `state_id` (state code)
- `primary_demand_location` (`Y`/`N` flag)

### Internal Fields
- `location_sk`
- `location_ck` (same as `location_id`)
- `load_ts`
- `modified_ts`

### Rules
- one row per `location_ck` (`location_id`)
- required fields must be populated
- `primary_demand_location` constrained to `Y` or `N`

### Source Mapping
Source file: `datafiles/locationdata.csv`

---

## 3C. Customer Dimension (`dim_customer`)

### Purpose
Slim, analytics-ready customer dimension for the unified demand MVP.

### Table
`dim_customer`

### Required Fields
- `site` (operating site / region code)
- `customer_no` (source customer identifier)
- `customer_name` (customer display name)
- `city`
- `state`
- `zip`
- `premise_code`
- `status`
- `license_name`
- `store_type_desc`
- `chain_type_desc`
- `state_chain_name`
- `corp_chain_name`
- `rpt_channel_desc`
- `rpt_sub_channel_desc`
- `rpt_ship_type_desc`
- `customer_acct_type_desc`
- `delivery_freq_code`

### Internal Fields
- `customer_sk`
- `customer_ck` (composite key: `site` + `-` + `customer_no`)
- `load_ts`
- `modified_ts`

### Rules
- one row per `customer_ck` (`site-customer_no`)
- `site` and `customer_no` are required and define identity
- if duplicate keys exist during load, the latest row in file order wins

### Source Mapping
Source file: `datafiles/customerdata.csv`

### MVP Pipeline
1. Normalize `customerdata.csv` into `customerdata_clean.csv`.
2. Load into Postgres `dim_customer` with `customer_ck = site-customer_no`.
3. Publish to Iceberg as `iceberg.silver.dim_customer`.
4. Expose via unified API and UI (`/domains/customer`).

---

## 3D. Time Dimension (`dim_time`)

### Purpose
Reusable calendar/time dimension for all domains. Auto-generated, not sourced from a file.

### Table
`dim_time`

### Internal Keys
- `time_sk` (surrogate key)
- `time_ck` (same as `date_key`)

### Required Fields
- `date_key` (date)
- `day_name`, `day_of_week` (ISO: Monday=1...Sunday=7), `day_of_month`, `day_of_year`
- `iso_week_year`, `iso_week`, `week_start_date`, `week_end_date`
- `month_number`, `month_name`, `month_start_date`, `month_end_date`
- `quarter_number`, `quarter_label`, `quarter_start_date`, `quarter_end_date`
- `year_number`, `year_start_date`, `year_end_date`
- `week_bucket` (`YYYY-Www`), `month_bucket` (`YYYY-MM`), `quarter_bucket` (`YYYY-Qn`), `year_bucket` (`YYYY`)
- `load_ts`, `modified_ts`

### Generation Rules
- Range: `2020-01-01` through `2035-12-31` (inclusive)
- One row per day
- `time_ck = date_key`
- Week values use ISO calendar semantics
- ISO week-year can differ from calendar year near year boundaries

### Pipeline
Generated by: `mvp/demand/scripts/normalize_dataset_csv.py --dataset time`
Output: `mvp/demand/data/timedata_clean.csv`

---

## 3E. DFU Dimension (`dim_dfu`)

### Purpose
DFU attribute dimension at item-customerGroup-location grain.

### Grain
- One row per item-customerGroup-location triple (`dmdunit`, `dmdgroup`, `loc`)
- `dmdgroup` is present in source but currently aggregated at `ALL`

### Table
`dim_dfu`

### Internal Fields
- `dfu_sk`
- `dfu_ck` (`dmdunit` + `_` + `dmdgroup` + `_` + `loc`)
- `load_ts`
- `modified_ts`

### Required Fields
- `dmdunit`, `loc`, `dmdgroup`
- `brand`, `brand_desc`, `region`, `state_plan`, `sales_div`
- `prod_cat_desc`, `prod_class_desc`, `subclass_desc`
- `supplier_desc`, `producer_desc`
- `size`, `brand_size`
- `file_dt`, `histstart`
- `cluster_assignment`

### Additional Attributes Loaded
- `abc_vol`, `ded_div_sw`, `execution_lag`, `otc_status`, `premise`
- `prod_subgrp_desc`, `service_lvl_grp`, `supergroup`, `total_lt`, `vintage`
- `purge_sw`, `alcoh_pct`, `bot_type_desc`, `cnty`, `dom_imp_opt`
- `grape_vrty_desc`, `material`, `proof`, `sop_ref`

### Source Mapping
Source file: `datafiles/dfu.txt` (pipe-delimited, header row)

Key mappings:
- `DMDUNIT` -> `dmdunit`, `DMDGROUP` -> `dmdgroup`, `LOC` -> `loc`
- `BRAND` -> `brand`, `U_ABC_VOL` -> `abc_vol`
- `U_BRAND_DESC` -> `brand_desc`, `U_REGION` -> `region`
- `U_EXECUTION_LAG` -> `execution_lag`, `U_TOTAL_LT` -> `total_lt`
- `U_CLUSTER_ASSIGNMENT` -> `cluster_assignment`
- (40+ total column mappings from source)

### MVP Pipeline
1. Normalize: `make normalize-dfu` -> `data/dfu_clean.csv`
2. Load: `make load-dfu` -> Postgres `dim_dfu`
3. Publish: `make spark-dfu` -> `iceberg.silver.dim_dfu`
4. API: `/domains/dfu`, `/domains/dfu/page`, `/dfus`, `/dfus/page`

---

## Shared Conventions (All Dimensions)
- Surrogate key `_sk`, composite business key `_ck`
- `load_ts` and `modified_ts` audit timestamps
- Full-text search via `pg_trgm` trigram indexes on configured fields
- All domains served via generic API: `GET /domains/{domain}/rows`, `GET /domains/{domain}/search`
- Reserved word workaround: `class` column aliased as `class_` in API responses
